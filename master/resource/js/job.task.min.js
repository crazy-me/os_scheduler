var REQ_JOB_LIST = "/job/list";
var REQ_JOB_SAVE = "/job/save";
var REQ_JOB_DEL = "/job/del";
var REQ_JOB_KILL = "/job/kill";

$(document).ready(function () {
    // Event handler for bound button,
    $("#job-list").on("click", ".edit-job", function (event) {
        $("#edit-id").val($(this).parents('tr').children(".job-id").text());
        $("#edit-name").val($(this).parents('tr').children(".job-name").text());
        $("#edit-type").val($(this).parents('tr').children(".job-type").text());
        $("#edit-command").val($(this).parents('tr').children(".job-command").text());
        $("#edit-expr").val($(this).parents('tr').children(".job-expr").text());
        $("#edit-modal").modal("show");
    });

    $("#create-job").on("click", function () {
        // clean form
        $("#edit-id").val("").attr("disabled",false);
        $("#edit-name").val("").attr("disabled",false);
        $("#edit-type").val("").attr("disabled",false);
        $("#edit-command").val("").attr("disabled",false);
        $("#edit-expr").val("").attr("disabled",false);
        $("#edit-modal").modal("show");
    })

    $("#job-list").on("click", ".del-job", function (event) {
        deleteJob(this);
    });

    $("#job-list").on("click", ".kill-job", function (event) {
        killerJob(this);
    });

    $("#save-job").on("click", function () {
        saveJob(this);
    });
    loadJobList();
})

// job list
var loadJobList = function () {
    $.ajax({
        url: REQ_JOB_LIST,
        type: 'POST',
        dataType: "json",
        success: function (resp) {
            if (resp.code != 0) {
                return
            }
            var jobList = resp.data;
            $("#job-list tbody").empty();
            // fill data
            for (var i = 0; i < jobList.length; ++i) {
                var job = jobList[i];
                var tr = $("<tr>");
                tr.append($('<td class="job-id">').html(job.job_id));
                tr.append($('<td class="job-name">').html(job.job_name));
                tr.append($('<td class="job-type">').html(job.job_type));
                tr.append($('<td class="job-command">').html(job.job_command));
                tr.append($('<td class="job-expr">').html(job.job_expr));
                var bar = $('<div class="btn-toolbar">')
                    .append('<button type="button" class="btn btn-info edit-job">update</button>')
                    .append('<button type="button" class="btn btn-danger del-job">delete</button>')
                    .append('<button type="button" class="btn btn-warning kill-job">killer</button>')
                tr.append($('<td>').append(bar));
                $("#job-list tbody").append(tr);
            }
        },
    });
}
// update job
var saveJob = function (_this) {
    var data = {
        job_id: parseInt($("#edit-id").val()),
        job_name: $("#edit-name").val(),
        job_type: $("#edit-type").val(),
        job_command: $("#edit-command").val(),
        job_expr: parseInt($("#edit-expr").val()),
    }

    $.ajax({
        url: REQ_JOB_SAVE,
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify(data),
        success: function (resp) {
            if (resp.code != 0) {
                alert(resp.message);
                return;
            } else {
                alert(resp.message);
                window.location.reload();
            }
        },
    });
}
// delete job
var deleteJob = function (_this) {
    var _element = $(_this).parents("tr");
    var data = {
        job_id: parseInt(_element.children(".job-id").text()),
        job_type: _element.children(".job-type").text(),
    };
    $.ajax({
       url: REQ_JOB_DEL,
       type: 'POST',
       dataType: 'json',
       data: JSON.stringify(data),
       success: function (resp) {
           if (resp.code != 0) {
               alert(resp.message);
               return;
           } else {
               alert(resp.message);
               window.location.reload();
           }
       },
    });
}
// kill job
var killerJob = function (_this) {
    var _element = $(_this).parents("tr");
    var data = {
        job_id: parseInt(_element.children(".job-id").text()),
        job_type: _element.children(".job-type").text(),
    };
    $.ajax({
        url: REQ_JOB_KILL,
        type: 'POST',
        dataType: 'json',
        data: JSON.stringify(data),
        success: function (resp) {
            if (resp.code != 0) {
                alert(resp.message);
                return;
            } else {
                alert(resp.message);
                window.location.reload();
            }
        },
    });
}
